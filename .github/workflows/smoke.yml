name: PR smoke (make docker + run)

on:
  pull_request:

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build docker image (make docker)
        run: |
          set -e
          make docker

      - name: Tag built image deterministically
        run: |
          set -e
          IMAGE_ID="$(docker images --format '{{.ID}}' | head -n 1)"
          echo "Newest image id: $IMAGE_ID"
          docker tag "$IMAGE_ID" "cadvisor-pr:${GITHUB_SHA}"

      - name: Run container + scrape /metrics
        run: |
          set -e
          # If anything fails, print logs before exiting.
          cleanup() {
            docker logs cadvisor-smoke 2>/dev/null || true
            docker stop cadvisor-smoke 2>/dev/null || true
          }
          trap cleanup EXIT

          docker run -d --rm --name cadvisor-smoke -p 18080:8080 \
            --privileged \
            -v /:/rootfs:ro \
            -v /var/run:/var/run:ro \
            -v /sys:/sys:ro \
            -v /var/lib/docker/:/var/lib/docker:ro \
            "cadvisor-pr:${GITHUB_SHA}"

          sleep 10
          curl -f http://127.0.0.1:18080/metrics
